var V=Object.defineProperty;var P=(i,t,e)=>t in i?V(i,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):i[t]=e;var C=(i,t,e)=>(P(i,typeof t!="symbol"?t+"":t,e),e),A=(i,t,e)=>{if(!t.has(i))throw TypeError("Cannot "+e)};var l=(i,t,e)=>(A(i,t,"read from private field"),e?e.call(i):t.get(i)),D=(i,t,e)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,e)};import{x as H,r as z}from"./el-message-6d880e39.js";/* empty css                */import{a0 as B,r as w,w as O,f as p,q as x,$,P as I,l as f,u as v,R as U,h as S,W as N,x as T,j as b,D as F}from"./index-481bb3df.js";import{u as q}from"./useDrag-828ece2b.js";function L(i){const t=Math.floor(i/1e3),e=Math.floor(t/3600),s=Math.floor(t%3600/60),o=t%60,a=i%1e3;let r=[e.toString().padStart(2,"0"),s.toString().padStart(2,"0"),o.toString().padStart(2,"0")].join(":");return a>0&&(r+=`.${a.toString().padStart(3,"0")}`),r}function j(i,t){if(!i)return 0;const e=t.findIndex(s=>i/10<=s);return e?e===0?0:e-1:t.length-1}const X=(i,t)=>{const e={...t};for(let s in i)i.hasOwnProperty(s)&&(typeof i[s]=="object"&&!Array.isArray(i[s])&&typeof t[s]=="object"&&!Array.isArray(t[s])?e[s]=X(i[s],t[s]):e[s]=i[s]);return e},R={root:"",totalTime:1e4,zoom:[20,100,200,1e3,6e3,12*1e3,120*1e3,360*1e3,720*1e3],level:0,lineStyle:{height:5,longerHeight:10,gap:20,color:"#6c707e"},fontStyle:{color:"#e5e5e5",font:"12px"},onClick:i=>{}},W={currentTime:0};var n;class G{constructor(t,e=R){D(this,n,{isMouseDown:!1,isMouseClick:!1,isMouseOut:!0,mouseX:0,offset:0,lastOffset:0,hoverLineX:0});C(this,"renderHeight",0);C(this,"canvasAttr",{offset:0,count:0});if(!t){console.warn("root dom can not be null");return}this.el=typeof t=="string"?document.querySelector(t):t,this.options=X(e,R),this.canvas=null,this.ctx=null,this.init()}init(){this.options.level=j(this.options.totalTime,this.options.zoom);const t=new Proxy(W,{get:(a,r)=>a[r],set:(a,r,u)=>(a[r]=u,this.drawTimeline(),!0)});this.player=t;const{canvas:e,ctx:s}=this.createCanvas(this.el);this.canvas=e,this.ctx=s,this.renderHeight=e.height/2,this.update(0),window.addEventListener("resize",()=>{const{width:a,height:r}=this.el.getBoundingClientRect();e.width=a,e.height=r,this.update(0)});const o={mousewheel:this.onMousewheel.bind(this),mousedown:this.onMouseDown.bind(this),mousemove:this.onMouseMove.bind(this),mouseout:this.onMouseOut.bind(this),mouseup:this.onMouseUp.bind(this)};Object.keys(o).forEach(a=>{e.addEventListener(a,o[a])})}onMousewheel(t){t.wheelDelta>0?this.options.level<this.options.zoom.length-1&&(this.options.level+=1):this.options.level>0&&(this.options.level-=1),this.drawTimeline()}onMouseMove(t){l(this,n).isMouseOut=!1,l(this,n).isMouseClick=!1,l(this,n).isMouseDown&&(l(this,n).offset=t.clientX-l(this,n).mouseX,this.drawTimeline());const{left:e}=this.canvas.getBoundingClientRect();l(this,n).hoverLineX=t.clientX-e,this.drawTimeline()}onMouseDown(t){l(this,n).isMouseDown=!0,l(this,n).isMouseClick=!0,l(this,n).mouseX=t.clientX,l(this,n).lastOffset=l(this,n).offset+l(this,n).lastOffset,l(this,n).offset=0}onMouseUp(t){if(l(this,n).isMouseClick){const{left:e}=this.canvas.getBoundingClientRect();this.options.onClick(...this.getCurrentTime(t.clientX-e))}this.onMouseOut(t)}onMouseOut(t){l(this,n).isMouseOut=!0,l(this,n).isMouseDown&&(l(this,n).isMouseDown=!1)}getTimeX(t=0){const{offset:e}=this.canvasAttr,{zoom:s,level:o,lineStyle:a}=this.options,r=s[o];return t/r*a.gap-(0-e)}drawTimeline(){const{zoom:t,level:e,lineStyle:s,fontStyle:o}=this.options;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="#ffdc23",this.ctx.fillRect(0,0,this.canvas.width,1);const a=Math.floor(this.canvas.width/s.gap);let r=0-Math.floor((l(this,n).offset+l(this,n).lastOffset)/s.gap);this.canvasAttr.offset=l(this,n).offset+l(this,n).lastOffset,this.canvasAttr.count=a,r<=0&&(r=0,l(this,n).offset=0,l(this,n).lastOffset=0),this.drawEndLine(),this.drawPlayline(),this.drawHoverLine(l(this,n).hoverLineX);for(let u=0;u<=a;u++){const m=(u+r)%5===0,g=m?s.longerHeight:s.height;if(this.ctx.fillStyle=s.color,this.ctx.fillRect(s.gap*u,1,1,g),m){this.ctx.fillStyle=o.color,this.ctx.font=o.font;const _=s.gap*u;this.ctx.fillText(L((u+r)*t[e]),_,g+12)}}}drawHoverLine(t=0,e=0){if(l(this,n).isMouseOut)return;this.ctx.fillStyle="#fff",this.ctx.fillRect(t,e,1,this.canvas.height);const[s]=this.getCurrentTime(t);this.ctx.fillText(s,t+5,this.canvas.height-12)}drawPlayline(){const t=this.getTimeX(this.player.currentTime),[e]=this.getCurrentTime(t);this.ctx.fillStyle="rgba(117, 252, 162, .3)",this.ctx.fillRect(0,0,t,this.renderHeight),this.ctx.fillStyle="rgba(117, 252, 162, .5)",this.ctx.fillText(e,t+5,this.renderHeight-14)}drawEndLine(){const t=this.getTimeX(this.options.totalTime),[e]=this.getCurrentTime(t);this.ctx.fillStyle="rgba(232, 0, 0, .1)",this.ctx.fillRect(0,0,t,this.renderHeight),this.ctx.fillStyle="rgba(232, 0, 0, 1)",this.ctx.fillText(e,t+5,this.renderHeight-2)}getCurrentTime(t=0){const{offset:e}=this.canvasAttr,{zoom:s,level:o,lineStyle:a}=this.options,r=s[o],u=Math.floor((t+(0-e))/a.gap*r);return[L(u),u]}createCanvas(t){const{width:e,height:s}=t.getBoundingClientRect(),o=document.createElement("canvas");o.width=e,o.height=s,t.appendChild(o);const a=o.getContext("2d");return{canvas:o,ctx:a}}update(t=0){t>this.options.totalTime&&(t=this.options.totalTime),this.player.currentTime=t}destroy(){this.el.removeChild(this.canvas)}}n=new WeakMap;const J={__name:"upload",props:{label:{type:String,default:"click/drag to upload"},modelValue:{type:Object,default:()=>({})}},emits:["change","update:modelValue"],setup(i,{emit:t}){const e=i,s=w(null),o=w({}),a=d=>{const c=Array.from(d);if(c.length){if(c.every(h=>!/^video/.test(h.type))){H.error("请不要上传非视频文件");return}o.value={url:window.URL.createObjectURL(d[0]),file:d[0]},t("change",o.value)}},{uploadLoading:r,onDrop:u,onDragleave:m,onDragenter:g,onFileChange:_}=q(a),M=()=>{r.value||(s.value.value="",s.value.click())};return O(()=>o.value,d=>{t("update:modelValue",d)}),O(()=>e.modelValue,d=>{o.value=d}),(d,c)=>(p(),x("div",{class:"upload",onDrop:c[1]||(c[1]=(...h)=>v(u)&&v(u)(...h)),onDragleave:c[2]||(c[2]=(...h)=>v(m)&&v(m)(...h)),onDragenter:c[3]||(c[3]=(...h)=>v(g)&&v(g)(...h)),onClick:M},[$(I(e.label)+" ",1),f("input",{type:"file",ref_key:"fileInput",ref:s,multiple:"",hidden:"",onChange:c[0]||(c[0]=(...h)=>v(_)&&v(_)(...h))},null,544)],32))}},K=B(J,[["__scopeId","data-v-42eab9f5"]]),Q={class:"video-player"},Y={class:"video-player__wrap"},Z={class:"video-player__player"},tt=["src"],et={key:0,class:"video-player__control"},st=["onClick"],it=f("div",{class:"video-player__timeline"},[f("div",{id:"timeline"})],-1),ot={__name:"video",setup(i){const t=w(null),e=w(null),s=w(null),o=w(!0),a=()=>{s.value.paused?s.value.play():(s.value.pause(),o.value=!0)},r=()=>{if(console.log("ready"),e.value)return;const{duration:c}=s.value;e.value=new G("#timeline",{totalTime:c*1e3,onClick:(h,y)=>{console.log(h),e.value.update(y),u(y/1e3)}}),window.timeline=e.value},u=(c=0)=>{s.value.pause(),s.value.currentTime=c,o.value||s.value.play()},m=c=>{e.value.update(Math.floor(c.target.currentTime*1e3))},g=()=>{o.value=!0},_=()=>{o.value=!1},M=()=>{o.value=!0},d=()=>{t.value=null,e.value.destroy(),e.value=null,o.value=!0,s.value=null};return(c,h)=>{const y=U("v-icon"),k=z;return p(),x("div",Q,[f("div",Y,[f("div",Z,[t.value?(p(),x("div",{key:0,style:{"background-color":"#000",height:"100%"},onClick:a},[f("video",{ref_key:"video",ref:s,id:"video",src:t.value.url,muted:"",onLoadedmetadata:r,onEnded:g,onPlay:_,onPause:M,onTimeupdate:m},null,40,tt)])):(p(),S(K,{key:1,modelValue:t.value,"onUpdate:modelValue":h[0]||(h[0]=E=>t.value=E)},null,8,["modelValue"]))]),t.value?(p(),x("div",et,[f("span",{class:"control-button",onClick:N(a,["stop"])},[T(k,{size:50},{default:b(()=>[o.value?(p(),S(y,{key:0,icon:"mdi:play"})):(p(),S(y,{key:1,icon:"mdi:pause"}))]),_:1})],8,st),f("span",{class:"control-button",title:"移除",onClick:d},[T(k,{size:50},{default:b(()=>[T(y,{icon:"mdi:close-thick",color:"#f00"})]),_:1})])])):F("",!0)]),it])}}};const nt={class:"convert"},lt=f("div",{class:"convert-toolbar"},null,-1),at={class:"convert-player"},ft={__name:"convert",setup(i){return(t,e)=>(p(),x("div",nt,[lt,f("div",at,[T(ot)])]))}};export{ft as default};
